<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Mannschaftskasse">
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="icon" href="icon.png" />
  <link rel="manifest" href="manifest.json" />
  <title>Mannschaftskasse</title>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #faeaea;
      margin: 0;
      padding: 0;
    }

    body.dark-mode {
      background-color: #333;
      color: white;
    }

    .container {
      max-width: 950px;
      margin: 40px auto;
      padding: 30px;
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    body.dark-mode .container {
      background-color: #444;
    }

    h1 {
      text-align: center;
      color: #e74c3c;
      margin-bottom: 30px;
      font-size: 36px;
    }

    .player-form,
    .penalty-form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 25px;
    }

    input, select, button {
      padding: 10px;
      border: 1px solid #ccc;
      background-color: #f8f8f8;
      border-radius: 6px;
      font-size: 15px;
    }

    input[type="number"] {
      width: 100px;
    }

    button {
      background-color: #e74c3c;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #c0392b;
    }

    .player-card {
      background-color: #fdfdfd;
      padding: 18px;
      margin-bottom: 18px;
      border-radius: 10px;
      border: 1px solid #ddd;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    }

    body.dark-mode .player-card {
      background-color: #555;
      color: white;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      font-size: 18px;
      color: #2c3e50;
      border-bottom: 2px solid #e74c3c;
      padding-bottom: 6px;
    }

    body.dark-mode .header {
      color: white;
    }

    .details {
      margin-top: 15px;
      display: none;
      padding-top: 10px;
      border-top: 2px solid #ddd;
    }

    .penalty-list {
      margin-top: 15px;
    }

    .penalty-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      padding: 6px 10px;
      background-color: #f2f2f2;
      border-left: 5px solid #e74c3c;
      border-radius: 4px;
      font-size: 14px;
    }

    .paid {
      text-decoration: line-through;
      color: #999;
      background-color: #e0e0e0;
    }

    .penalty-item button {
      margin-left: 6px;
      font-size: 13px;
    }

    .totals {
      margin-top: 10px;
      font-weight: bold;
      color: #2c3e50;
    }

    .btn-danger {
      background-color: #bd2130;
      margin-top: 10px;
    }

    .btn-danger:hover {
      background-color: #a71d2a;
    }

    .toggle-btn {
      background-color: #555;
      color: white;
      margin-top: 10px;
    }

    .summary {
      margin-top: 30px;
      font-size: 18px;
      font-weight: bold;
      color: #e74c3c;
      padding-top: 20px;
      border-top: 2px solid #ccc;
    }

    .search {
      margin-bottom: 20px;
    }

    .dark-mode-toggle {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 10px;
      background-color: #555;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 50%;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Mannschaftskasse</h1>

    <!-- Dark Mode Toggle -->
    <button class="dark-mode-toggle" onclick="toggleDarkMode()">üåô</button>

    <!-- Search Bar -->
    <div class="search">
      <input type="text" id="search" placeholder="Spieler suchen..." oninput="searchPlayer()" />
    </div>

    <div class="player-form">
      <input type="text" id="firstName" placeholder="Vorname" />
      <input type="text" id="lastName" placeholder="Nachname" />
      <button onclick="addPlayer()">Spieler hinzuf√ºgen</button>
    </div>

    <div id="players"></div>

    <div class="summary">
      <div><strong>Gesamt offene Strafen:</strong> <span id="totalOpen">0</span>‚Ç¨</div>
      <div><strong>Gesamt bezahlte Strafen:</strong> <span id="totalPaid">0</span>‚Ç¨</div>
      <div><strong>Gesamtbetrag:</strong> <span id="totalAmount">0</span>‚Ç¨</div>
    </div>

    <!-- CSV Export Button -->
    <button onclick="exportCSV()">CSV Export</button>
  </div>

  <script>
    let players = [];
    let darkMode = false;

    function saveData() {
      localStorage.setItem("playersData", JSON.stringify(players));
    }

    function loadData() {
      const data = localStorage.getItem("playersData");
      if (data) {
        players = JSON.parse(data);
      }
    }

    function addPlayer() {
      const first = document.getElementById("firstName").value.trim();
      const last = document.getElementById("lastName").value.trim();
      if (!first || !last) return alert("Vor- und Nachname eingeben");

      players.push({
        id: Date.now(),
        name: `${first} ${last}`,
        penalties: [],
        isOpen: false
      });

      renderPlayers();
      saveData();
      document.getElementById("firstName").value = "";
      document.getElementById("lastName").value = "";
    }

    function deletePlayer(id) {
      const player = players.find(p => p.id === id);
      const confirmDelete = confirm(`Spieler ${player.name} wirklich l√∂schen?`);
      if (confirmDelete) {
        players = players.filter(p => p.id !== id);
        renderPlayers();
        saveData();
      }
    }

    function toggleDetails(id) {
      const player = players.find(p => p.id === id);
      player.isOpen = !player.isOpen;
      renderPlayers();
    }

    function addPenalty(playerId, label, amount) {
      if (amount <= 0 || isNaN(amount)) return alert("G√ºltigen Betrag eingeben");

      const player = players.find(p => p.id === playerId);
      player.penalties.push({ label, amount, paid: false });
      player.isOpen = true;
      renderPlayers();
      saveData();
    }

    function togglePaid(playerId, index) {
      const player = players.find(p => p.id === playerId);
      player.penalties[index].paid = !player.penalties[index].paid;
      renderPlayers();
      saveData();
    }

    function deletePenalty(playerId, penaltyIndex) {
      const player = players.find(p => p.id === playerId);
      player.penalties.splice(penaltyIndex, 1);
      renderPlayers();
      saveData();
    }

    function calculateTotals() {
      let totalOpen = 0;
      let totalPaid = 0;
      players.forEach(player => {
        player.penalties.forEach(p => {
          if (p.paid) totalPaid += p.amount;
          else totalOpen += p.amount;
        });
      });
      document.getElementById("totalOpen").textContent = totalOpen;
      document.getElementById("totalPaid").textContent = totalPaid;
      document.getElementById("totalAmount").textContent = totalOpen + totalPaid;
    }

    function renderPlayers() {
      const container = document.getElementById("players");
      container.innerHTML = "";
      players.forEach(player => {
        const card = document.createElement("div");
        card.className = "player-card";
        card.innerHTML = `
          <div class="header" onclick="toggleDetails(${player.id})">
            <div><strong>${player.name}</strong></div>
            <div>Offen: ${player.penalties.filter(p => !p.paid).reduce((sum, p) => sum + p.amount, 0)}‚Ç¨</div>
          </div>
          
          <div class="details" style="display: ${player.isOpen ? 'block' : 'none'}">
            <div class="penalty-form">
              <select id="penalty-${player.id}">
                <option value="5">Diverses (Ball/Sachen vergessen) - 5‚Ç¨</option>
                <option value="20">Trinken im Dress - 20‚Ç¨</option>
                <option value="50">Gelb f√ºr Unsportlichkeit - 50‚Ç¨</option>
                <option value="100">Rot f√ºr Unsportlichkeit - 100‚Ç¨</option>
              </select>
              <button onclick="addPenalty(${player.id}, 'Strafe', parseInt(document.querySelector('#penalty-${player.id}').value))">Strafe hinzuf√ºgen</button>
            </div>

            <div class="penalty-list">
              ${player.penalties.map((p, idx) => `
                <div class="penalty-item ${p.paid ? 'paid' : ''}">
                  <span>${p.label} - ${p.amount}‚Ç¨</span>
                  <div>
                    <button onclick="togglePaid(${player.id}, ${idx})">${p.paid ? 'Bezahlt' : 'Bezahlt markieren'}</button>
                    <button onclick="deletePenalty(${player.id}, ${idx})">L√∂schen</button>
                  </div>
                </div>
              `).join("")}
            </div>

            <div class="totals">
              <div><strong>Gesamt Strafen: </strong>${player.penalties.reduce((sum, p) => sum + p.amount, 0)}‚Ç¨</div>
            </div>

            <button class="btn-danger" onclick="deletePlayer(${player.id})">Spieler l√∂schen</button>
          </div>
        `;
        container.appendChild(card);
      });
      calculateTotals();
    }

    function searchPlayer() {
      const searchTerm = document.getElementById("search").value.toLowerCase();
      players.forEach(player => {
        const card = document.querySelector(`#player-${player.id}`);
        card.style.display = player.name.toLowerCase().includes(searchTerm) ? 'block' : 'none';
      });
    }

    function exportCSV() {
      const headers = ["Name", "Strafen"];
      const rows = players.map(player => [
        player.name,
        player.penalties.map(p => `${p.label} (${p.amount}‚Ç¨)`).join(", ")
      ]);

      let csvContent = "data:text/csv;charset=utf-8,"
        + headers.join(",") + "\n"
        + rows.map(e => e.join(",")).join("\n");

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "mannschaftskasse.csv");
      link.click();
    }

    function toggleDarkMode() {
      darkMode = !darkMode;
      document.body.classList.toggle("dark-mode", darkMode);
    }

    loadData();
    renderPlayers();
  </script>
</body>
</html>
